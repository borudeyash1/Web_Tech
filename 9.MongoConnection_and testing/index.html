<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mongo Students </title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Mongo Students</h1>
    <section class="panel">
      <form id="add-form">
        <input id="name" placeholder="Name" required />
        <input id="age" type="number" placeholder="Age" />
        <input id="major" placeholder="Major" />
        <button>Add</button>
      </form>
      <div id="add-result" class="result"></div>
    </section>

    <section class="panel">
        <div>
      <h2>Students</h2>
      <div class="selector">
        
        <button class="select-all">Select all</button>
        <button id="bulk-delete" class="danger" disabled>Bulk Delete</button>
        <span id="selected-count" class="selected-count">Selected: 0</span>
      </div>
      </div>
      <div id="students-list"></div>
      <button id="refresh">Refresh</button>
    </section>

  <section class="panel hidden" id="edit-panel">
      <h2>Edit student</h2>
      <form id="edit-form">
        <input id="edit-id" type="hidden" />
        <input id="edit-name" placeholder="Name" required />
        <input id="edit-age" type="number" placeholder="Age" />
        <input id="edit-major" placeholder="Major" />
        <button type="submit">Save</button>
        <button type="button" id="cancel-edit">Cancel</button>
      </form>
      <div id="edit-result" class="result"></div>
    </section>
  </div>

<script>
const apiRoot = '';
async function fetchStudents(){
  const list = document.getElementById('students-list');
  list.innerHTML = 'Loading...';
  try{
    const res = await fetch('/students');
    if(!res.ok) throw new Error('Fetch failed');
    const students = await res.json();
    list.innerHTML = students.map(s => `
      <div class="student" data-id="${s._id}">
        <input type="checkbox" class="student-checkbox" data-id="${s._id}" />
        <div><strong>${s.name}</strong></div>
        <div>${s.age ?? ''}</div>
        <div>${s.major ?? ''}</div>
        <div class="student-actions">
          <button class="btn-secondary" data-action="edit" data-id="${s._id}">Edit</button>
          <button data-action="delete" data-id="${s._id}">Delete</button>
        </div>
      </div>
    `).join('');
    updateSelectedCount();
  }catch(e){
    list.innerHTML = '<div class="error">Error loading students</div>';
  }
}

document.getElementById('refresh').addEventListener('click', fetchStudents);
document.getElementById('add-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const age = document.getElementById('age').value;
  const major = document.getElementById('major').value.trim();
  try{
    const res = await fetch('/students', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({name, age: age?Number(age):undefined, major})});
    if(!res.ok) throw new Error('Add failed');
    document.getElementById('add-result').textContent = 'Added';
    e.target.reset();
    fetchStudents();
  }catch(err){
    document.getElementById('add-result').textContent = 'Error adding';
  }
});
// Delegated click handler for edit/delete
document.getElementById('students-list').addEventListener('click', (e)=>{
  const btn = e.target.closest('button');
  if (!btn) return;
  const action = btn.getAttribute('data-action');
  const id = btn.getAttribute('data-id');
  if (action === 'delete') deleteStudent(id);
  if (action === 'edit') openEdit(id);
});

// Handle checkbox change events (delegated)
document.getElementById('students-list').addEventListener('change', (e) => {
  const cb = e.target.closest('.student-checkbox');
  if (!cb) return;
  const row = cb.closest('.student');
  if (cb.checked) row.classList.add('selected'); else row.classList.remove('selected');
  updateSelectedCount();
});

// Select all / select student handlers
document.querySelector('.select-all').addEventListener('click', () => {
  const checkboxes = Array.from(document.querySelectorAll('.student-checkbox'));
  if (checkboxes.length === 0) return;
  const allChecked = checkboxes.every(c => c.checked);
  checkboxes.forEach(c => { c.checked = !allChecked; c.dispatchEvent(new Event('change')); });
});

document.querySelector('.select-student').addEventListener('click', () => {
  const q = prompt('Enter student ID or name to toggle selection:');
  if (!q) return;
  const rows = Array.from(document.querySelectorAll('.student'));
  let matched = 0;
  rows.forEach(r => {
    const id = r.getAttribute('data-id');
    const name = r.querySelector('strong')?.textContent || '';
    if (id === q || name.toLowerCase() === q.toLowerCase()) {
      const cb = r.querySelector('.student-checkbox');
      cb.checked = !cb.checked;
      cb.dispatchEvent(new Event('change'));
      matched++;
    }
  });
  if (matched === 0) alert('No matching student found');
});

function updateSelectedCount(){
  const count = document.querySelectorAll('.student-checkbox:checked').length;
  document.getElementById('selected-count').textContent = 'Selected: ' + count;
  const bulkBtn = document.getElementById('bulk-delete');
  if (bulkBtn) bulkBtn.disabled = count === 0;
}

// Bulk delete selected students
document.getElementById('bulk-delete').addEventListener('click', async () => {
  const checked = Array.from(document.querySelectorAll('.student-checkbox:checked'));
  if (checked.length === 0) { alert('No students selected'); return; }
  if (!confirm(`Delete ${checked.length} selected student(s)? This cannot be undone.`)) return;
  const btn = document.getElementById('bulk-delete');
  btn.disabled = true;
  btn.textContent = `Deleting (0/${checked.length})`;
  let deleted = 0;
  for (let i = 0; i < checked.length; i++) {
    const id = checked[i].getAttribute('data-id');
    try {
      const res = await fetch('/students/' + id, { method: 'DELETE' });
      if (!res.ok) throw new Error('Delete failed');
      deleted++;
    } catch (err) {
      console.error('Failed to delete', id, err);
      // continue with others
    }
    btn.textContent = `Deleting (${deleted}/${checked.length})`;
  }
  btn.textContent = 'Bulk Delete';
  btn.disabled = false;
  fetchStudents();
});

async function deleteStudent(id){
  if(!confirm('Delete this student?')) return;
  try{
    const res = await fetch('/students/' + id, { method: 'DELETE' });
    if(!res.ok) throw new Error('Delete failed');
    fetchStudents();
  }catch(err){
    alert('Delete failed');
  }
}

async function openEdit(id){
  try{
    const res = await fetch('/students/' + id);
    if(!res.ok) throw new Error('Not found');
    const s = await res.json();
    document.getElementById('edit-id').value = s._id;
    document.getElementById('edit-name').value = s.name;
    document.getElementById('edit-age').value = s.age || '';
    document.getElementById('edit-major').value = s.major || '';
    document.getElementById('edit-panel').classList.remove('hidden');
  }catch(err){
    alert('Could not load student');
  }
}

document.getElementById('cancel-edit').addEventListener('click', ()=>{
  document.getElementById('edit-panel').classList.add('hidden');
});

document.getElementById('edit-form').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const id = document.getElementById('edit-id').value;
  const name = document.getElementById('edit-name').value.trim();
  const age = document.getElementById('edit-age').value;
  const major = document.getElementById('edit-major').value.trim();
  try{
    const res = await fetch('/students/' + id, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ name, age: age?Number(age):undefined, major }) });
    if(!res.ok) throw new Error('Update failed');
    document.getElementById('edit-result').textContent = 'Saved';
    document.getElementById('edit-panel').classList.add('hidden');
    fetchStudents();
  }catch(err){
    document.getElementById('edit-result').textContent = 'Error saving';
  }
});
fetchStudents();
</script>
</body>
</html>